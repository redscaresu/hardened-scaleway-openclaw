#cloud-config

# Hardened server provisioning - infrastructure only
# Openclaw app sections are commented out below. To enable:
#   1. Uncomment the openclaw sections in this file (search for "OPENCLAW:")
#   2. Add openclaw_api_key to templatefile() params in main.tf
#   3. Set openclaw_api_key in terraform.tfvars

users:
  - name: ${admin_username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${ssh_public_key}

# Disable root login
disable_root: true

# System packages
package_update: true
package_upgrade: true
packages:
  - ufw
  - fail2ban
  - unattended-upgrades
  - apt-listchanges
  - git
  - curl
  - wget
  - vim
  - htop
  - prometheus-node-exporter
  - vnstat
  - aide
  - auditd
  - restic

# Write configuration files
write_files:
  # SSH hardening
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      ChallengeResponseAuthentication no
      X11Forwarding no
      AllowUsers ${admin_username}
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2
    permissions: '0644'

  # Kernel hardening
  - path: /etc/sysctl.d/99-security.conf
    content: |
      # IP forwarding (required by Tailscale)
      net.ipv4.ip_forward = 1

      # SYN flood protection
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2

      # Reverse path filtering
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1

      # Ignore ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0

      # Ignore source routed packets
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0

      # Log martian packets
      net.ipv4.conf.all.log_martians = 1

      # Ignore ICMP ping requests
      net.ipv4.icmp_echo_ignore_broadcasts = 1

      # Restrict dmesg
      kernel.dmesg_restrict = 1

      # Restrict kernel pointers
      kernel.kptr_restrict = 2
    permissions: '0644'

  # Unattended upgrades
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "$${distro_id}:$${distro_codename}-security";
          "$${distro_id}ESMApps:$${distro_codename}-apps-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "true";
      Unattended-Upgrade::Automatic-Reboot-Time "03:00";
    permissions: '0644'

  # Restic backup environment (password placeholder - replaced by runcmd)
  - path: /root/.restic-env
    content: |
      export AWS_ACCESS_KEY_ID="${aws_access_key}"
      export AWS_SECRET_ACCESS_KEY="${aws_secret_key}"
      export RESTIC_REPOSITORY="s3:s3.fr-par.scw.cloud/${backup_bucket}"
      export RESTIC_PASSWORD="PLACEHOLDER"
    permissions: '0600'

  # signal-cli alert configuration
  # SIGNAL_SENDER must be filled in after linking signal-cli (post-deploy step)
  - path: /etc/openclaw-alerts.conf
    content: |
      # Signal alert configuration for signal-cli
      # After deploying, link signal-cli then set SIGNAL_SENDER to your linked number
      SIGNAL_SENDER=""
      SIGNAL_RECIPIENT="${signal_alert_number}"
    permissions: '0600'

  # Signal alert script - sends alerts via standalone signal-cli
  # Falls back to syslog if signal-cli is not configured
  - path: /usr/local/bin/send-alert.sh
    content: |
      #!/bin/bash
      MESSAGE="$${1:-Alert from $(hostname)}"
      source /etc/openclaw-alerts.conf

      if [ -z "$SIGNAL_SENDER" ]; then
        logger -p user.warning -t signal-alert "ALERT (signal-cli not configured): $MESSAGE"
        exit 0
      fi

      /usr/local/bin/signal-cli -a "$SIGNAL_SENDER" send -m "$MESSAGE" "$SIGNAL_RECIPIENT" \
        2>&1 | logger -t signal-alert

      if [ $? -eq 0 ]; then
        logger -t signal-alert "Signal alert sent: $MESSAGE"
      else
        logger -p user.warning -t signal-alert "ALERT (signal-cli failed): $MESSAGE"
      fi
    permissions: '0755'

  # Backup script (system configs only - add openclaw paths later)
  - path: /usr/local/bin/backup-server.sh
    content: |
      #!/bin/bash
      set -euo pipefail
      source /root/.restic-env

      # Initialize repo if needed
      restic snapshots &>/dev/null || restic init

      # Backup system configs
      restic backup \
        /etc/ssh/sshd_config.d/ \
        /etc/sysctl.d/ \
        /etc/openclaw-alerts.conf \
        2>&1 | logger -t restic-backup

      # Prune old backups
      restic forget \
        --keep-daily 7 \
        --keep-weekly 4 \
        --keep-monthly 12 \
        --prune \
        2>&1 | logger -t restic-backup

      # Check repository
      restic check 2>&1 | logger -t restic-backup

      /usr/local/bin/send-alert.sh "Backup completed: $(date)"
    permissions: '0700'

  # AIDE check script
  - path: /usr/local/bin/aide-check.sh
    content: |
      #!/bin/bash
      REPORT=$(/usr/bin/aide --check 2>&1 | tail -30)
      if echo "$REPORT" | grep -q "changed\|added\|removed"; then
        /usr/local/bin/send-alert.sh "AIDE file integrity alert on $(hostname): $REPORT"
      fi
    permissions: '0755'

  # --- OPENCLAW: Uncomment the sections below to install the openclaw app ---

  # # OPENCLAW: Environment variables
  # - path: /var/lib/openclaw/.env
  #   content: |
  #     NODE_ENV=production
  #     ANTHROPIC_API_KEY=YOUR_API_KEY  # use $${openclaw_api_key} after adding to main.tf templatefile
  #   permissions: '0600'
  #   owner: openclaw:openclaw

  # # OPENCLAW: Systemd service
  # - path: /etc/systemd/system/openclaw.service
  #   content: |
  #     [Unit]
  #     Description=Openclaw AI Assistant
  #     After=network-online.target
  #     Wants=network-online.target
  #
  #     [Service]
  #     Type=simple
  #     User=openclaw
  #     Group=openclaw
  #     WorkingDirectory=/opt/openclaw
  #     Environment="NODE_ENV=production"
  #     EnvironmentFile=/var/lib/openclaw/.env
  #     ExecStart=/usr/bin/pnpm start
  #     Restart=always
  #     RestartSec=10
  #     StandardOutput=append:/var/log/openclaw/output.log
  #     StandardError=append:/var/log/openclaw/error.log
  #
  #     # Security hardening
  #     NoNewPrivileges=true
  #     PrivateTmp=true
  #     ProtectSystem=strict
  #     ProtectHome=true
  #     ReadWritePaths=/var/lib/openclaw /var/log/openclaw
  #     CapabilityBoundingSet=
  #     ProtectKernelTunables=true
  #     ProtectControlGroups=true
  #     RestrictRealtime=true
  #     RestrictNamespaces=true
  #     SystemCallFilter=@system-service
  #     SystemCallErrorNumber=EPERM
  #
  #     [Install]
  #     WantedBy=multi-user.target
  #   permissions: '0644'

  # # OPENCLAW: Health check script
  # - path: /usr/local/bin/openclaw-health.sh
  #   content: |
  #     #!/bin/bash
  #     if ! systemctl is-active --quiet openclaw; then
  #       /usr/local/bin/send-alert.sh "ALERT: Openclaw is down on $(hostname), restarting..."
  #       systemctl restart openclaw
  #     fi
  #   permissions: '0755'

# Run commands on first boot
runcmd:
  # Generate static restic backup password (once, not on every source)
  - |
    RESTIC_PW=$(openssl rand -base64 32)
    sed -i "s|PLACEHOLDER|$RESTIC_PW|" /root/.restic-env

  # Apply sysctl settings
  - sysctl -p /etc/sysctl.d/99-security.conf

  # Configure UFW
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw limit 22/tcp  # Rate-limit SSH: deny after 6 attempts in 30 seconds
  - ufw allow 41641/udp  # Tailscale
  - ufw --force enable

  # Enable unattended upgrades
  - dpkg-reconfigure -plow unattended-upgrades

  # Install signal-cli native binary for alerts (no Java required)
  - |
    SIGNAL_CLI_VERSION="0.13.12"
    curl -fsSL "https://github.com/AsamK/signal-cli/releases/download/v$${SIGNAL_CLI_VERSION}/signal-cli-$${SIGNAL_CLI_VERSION}-Linux-native.tar.gz" \
      | tar xz -C /opt
    ln -sf /opt/signal-cli /usr/local/bin/signal-cli

  # Install Tailscale
  - curl -fsSL https://tailscale.com/install.sh | sh
  - |
    if [ -n "${tailscale_auth_key}" ]; then
      tailscale up --authkey=${tailscale_auth_key} --ssh --accept-routes --advertise-tags=tag:openclaw
    fi

  # Set up cron jobs
  - echo "0 2 * * * root /usr/local/bin/backup-server.sh" >> /etc/crontab
  - echo "0 3 * * * root /usr/local/bin/aide-check.sh" >> /etc/crontab

  # --- OPENCLAW: Uncomment the sections below to install the openclaw app ---

  # # OPENCLAW: Install Node.js and pnpm
  # - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  # - apt-get install -y nodejs
  # - npm install -g pnpm

  # # OPENCLAW: Create system user with home directory for pnpm cache
  # - useradd --system --home-dir /var/lib/openclaw --shell /usr/sbin/nologin openclaw
  # - mkdir -p /opt/openclaw /var/lib/openclaw /var/log/openclaw
  # - chown openclaw:openclaw /var/lib/openclaw /var/log/openclaw
  # - chmod 700 /var/lib/openclaw

  # # OPENCLAW: Clone and install
  # - |
  #   cd /opt
  #   git clone https://github.com/openclaw/openclaw.git openclaw
  #   cd openclaw
  #   chown -R openclaw:openclaw /opt/openclaw
  #   HOME=/var/lib/openclaw sudo -u openclaw pnpm install

  # Enable and start services
  - systemctl daemon-reload
  - systemctl enable prometheus-node-exporter
  - systemctl start prometheus-node-exporter
  - systemctl enable auditd
  - systemctl start auditd

  # # OPENCLAW: Enable and start openclaw service
  # - systemctl enable openclaw
  # - systemctl start openclaw

  # Restart SSH with new config (Ubuntu 24.04 uses ssh.service, not sshd)
  - systemctl restart ssh

  # Block metadata API - cloud-init user_data contains secrets (tailscale key, backup creds)
  # Any process on the instance could read these via http://169.254.42.42/conf
  # Persisted via UFW before.rules (iptables-persistent conflicts with ufw)
  - iptables -A OUTPUT -d 169.254.42.42 -j DROP
  - sed -i '/^COMMIT/i -A ufw-before-output -d 169.254.42.42 -j DROP' /etc/ufw/before.rules

  # Set up cron jobs for openclaw health check (uncomment when openclaw is installed)
  # # OPENCLAW: Health check cron
  # - echo "*/5 * * * * root /usr/local/bin/openclaw-health.sh" >> /etc/crontab

  # Initialize AIDE baseline (must be last, after all services are configured)
  - aideinit
  - cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db

  # Send completion notification
  - logger -t server-setup "Server provisioning complete on $(hostname). Link signal-cli to enable alerts."

# Reboot after first boot to apply all settings
power_state:
  mode: reboot
  timeout: 300
  condition: true
